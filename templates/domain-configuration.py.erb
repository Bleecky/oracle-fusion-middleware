#===============================================================================
# Create Domain
#===============================================================================

readTemplate('<%= @middleware_home %>/wlserver_<%= @weblogic_version[/([\d.]+)\..*$/,1] %>/common/templates/domains/wls.jar')

#===============================================================================
# Configure Admin Domain
#===============================================================================

print '[INFO] Set Admin User'
cd('/')
cmo=cd('Security/base_domain/User/weblogic')
cmo.setPassword('<%= @weblogic_admin_pwd %>')

#===============================================================================
# Configure Machines
#===============================================================================

<% @config['machines'].each do | ds_config | -%>
oscustom.configureMachine()
<% end -%>

#===============================================================================
# Configure Servers
#===============================================================================

<% @config['servers'].each do | ds_config | -%>
oscustom.configureServers()
<% end -%>

#===============================================================================
# Configure Clusters
#===============================================================================

<% @config['clusters'].each do | ds_config | -%>
oscustom.configureClusters()
<% end -%>

#===============================================================================
# Configure Datasources
#===============================================================================
<%-
def jdbc_string(db_type, host_name, db_port, db_name)
  case db_type
    when /oracle/i
      if db_port.nil? || db_port.to_s.empty?
        db_port = 1521
      end
      jdbc_string = "jdbc:oracle:thin:@//#{host_name}:#{db_port}/#{db_name}"

    when /postgres(?:ql)?/i
      if db_port.nil? || db_port.to_s.empty?
        db_port = 5432
      end
      jdbc_string = "jdbc:postgresql://#{host_name}:#{db_port}/#{db_name}"

    else
      jdbc_string = "UNKNOWN db_type #{db_type}"
      #raise Puppet::ParseError, "Failed to construct JDBC connect string"
  end # End of case
  return jdbc_string
end
-%>
<% @config['datasources'].sort.each do | ds_name, ds_config | -%>
oscustom.configureDataSource(
  '<%= ds_name %>',
  '<%= ds_config['jdbc_driver'] %>',
  'jdbc/<%= ds_name %>',
  '<%= ds_config['user'] %>',
  '<%= ds_config['pwd'] %>',
  '<%= jdbc_string(ds_config['jdbc_driver'], ds_config['host'], ds_config['port'], (ds_config['sid'] or ds_config['database'])) %>')
<% end -%>

#===============================================================================
# Write and Save the Domain
#===============================================================================

print '[INFO] Writing the domain configuration'
writeDomain('<%= @middleware_home %>/user_projects/domains/<%= @config['domain']['name'] %>')
closeTemplate()
